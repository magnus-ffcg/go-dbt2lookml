#!/bin/sh
# Git pre-commit hook for go-dbt2lookml
# To install: ln -s ../../.githooks/pre-commit .git/hooks/pre-commit
# Or run: git config core.hooksPath .githooks

set -e

echo "ğŸ” Running pre-commit checks..."

# Check if files are formatted
echo "\n==> Checking Go formatting..."
UNFORMATTED=$(gofmt -l .)
if [ -n "$UNFORMATTED" ]; then
    echo "âŒ The following files are not formatted:"
    echo "$UNFORMATTED"
    echo "\nRun: make fmt"
    exit 1
fi
echo "âœ“ All files are formatted"

# Run go vet
echo "\n==> Running go vet..."
if ! go vet ./...; then
    echo "âŒ go vet failed"
    exit 1
fi
echo "âœ“ go vet passed"

# Run golangci-lint (if installed)
if command -v golangci-lint >/dev/null 2>&1; then
    echo "\n==> Running golangci-lint..."
    if ! golangci-lint run --timeout=5m; then
        echo "âŒ golangci-lint failed"
        exit 1
    fi
    echo "âœ“ golangci-lint passed"
else
    echo "\nâš ï¸  golangci-lint not installed (skipping)"
    echo "   Install with: go install github.com/golangci/golangci-lint/cmd/golangci-lint@v2.4.1"
fi

# Run tests
echo "\n==> Running tests..."
if ! go test ./... -short; then
    echo "âŒ Tests failed"
    exit 1
fi
echo "âœ“ Tests passed"

echo "\nâœ… All pre-commit checks passed!"
